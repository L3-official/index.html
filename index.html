<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L3 Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;500;800&family=Shippori+Mincho:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --l3-navy: #002b5b; --l3-lime: #e1ff00; --bg-body: #f8fafd; --l3-orange: #d9822b; }
        body { background: var(--bg-body); color: var(--l3-navy); font-family: 'Outfit', sans-serif; margin: 0; padding-bottom: 140px; -webkit-font-smoothing: antialiased; }
        .header-logo { width: 100%; padding: 40px 0 20px; display: flex; justify-content: center; background: #fff; }
        .logo-img { width: 160px; height: auto; }
        .container { width: 92%; max-width: 400px; margin: 20px auto; display: none; flex-direction: column; gap: 15px; }
        .container.active { display: flex; }
        .l3-card { background: #fff; border-radius: 35px; padding: 25px; box-shadow: 0 10px 30px rgba(0,43,91,0.03); text-align: center; }
        .member-name { font-family: 'Shippori Mincho', serif; font-size: 2.2rem; margin: 10px 0 5px; font-weight: 800; }
        
        /* --- 1. Á†ÇÊôÇË®à„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        .hourglass-wrapper { margin: 10px 0; display: flex; justify-content: center; }
        .hg-svg { width: 60px; height: auto; }
        .sand-stream { stroke: var(--l3-lime); stroke-width: 2; stroke-dasharray: 4; animation: flow 1s linear infinite; }
        @keyframes flow { from { stroke-dashoffset: 8; } to { stroke-dashoffset: 0; } }

        /* „Éú„Çø„É≥ */
        .btn-main { width: 100%; padding: 20px; border-radius: 20px; border: none; font-weight: 800; font-size: 1rem; cursor: pointer; color: #fff; transition: 0.3s; }
        .btn-attend { background: var(--l3-navy); }
        .btn-cancel { background: var(--l3-orange); }

        /* „Çπ„Çø„É≥„Éó */
        .stamp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .slot { aspect-ratio: 1/1; background: #f0f4f8; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 800; color: #d0d7de; }
        .slot.filled { background: var(--l3-navy); color: var(--l3-lime); }

        /* „Éó„É≠„Éï„Ç£„Éº„É´ */
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .m-card { background: #fff; border-radius: 25px; padding: 15px; text-align: center; border: 1px solid rgba(0,43,91,0.02); cursor: pointer; }
        .m-card.expanded { grid-column: span 2; padding: 25px; }
        .m-icon { width: 55px; height: 55px; background: #f0f4f8; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .m-img { width: 100%; height: 100%; object-fit: cover; }
        
        .detail-pane { display: none; margin-top: 15px; text-align: left; border-top: 1px solid #f0f4f8; padding-top: 15px; }
        .m-card.expanded .detail-pane { display: block; }
        .d-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f9fafb; }
        .d-label { font-size: 0.6rem; color: #94a3b8; font-weight: 800; text-transform: uppercase; }
        .d-val { font-size: 0.8rem; font-weight: 800; }

        /* --- 3. „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÆ„Çµ„Ç§„Ç∫Ë™øÊï¥ (1.5ÂÄç) --- */
        .accordion-item { background: #fff; border-radius: 25px; margin-bottom: 15px; overflow: hidden; border: 1px solid #eee; }
        .accordion-trigger { width: 100%; padding: 28px 25px; display: flex; justify-content: space-between; background: none; border: none; font-weight: 800; font-size: 1.2rem; color: var(--l3-navy); text-align: left; cursor: pointer; }
        .accordion-content { max-height: 0; overflow: hidden; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: #fcfdfe; }
        .accordion-inner { padding: 5px 25px 30px; font-size: 1.1rem; line-height: 1.8; color: #444; }
        
        /* „É™„É≥„ÇØ„ÅÆÊúâÂäπÂåñÁî®„Çπ„Çø„Ç§„É´ */
        .accordion-inner a { color: #0066cc; text-decoration: underline; font-weight: 800; }

        .feedback-area { width: 100%; min-height: 80px; border-radius: 15px; border: 1px solid #eee; padding: 12px; margin: 10px 0; outline: none; font-family: inherit; font-size: 0.8rem; }
        .nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; background: #01162d; border-radius: 30px; display: flex; justify-content: space-around; padding: 18px 0; z-index: 2000; }
        .nav-item { color: #fff; opacity: 0.3; font-size: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .nav-active { color: var(--l3-lime); opacity: 1; }
    </style>
</head>
<body>
    <header class="header-logo"><img src="l3-logo-official_transparent.png" class="logo-img" loading="lazy"></header>
    
    <main id="tab-mypage" class="container active">
        <div class="l3-card">
            <span style="font-size: 0.6rem; opacity: 0.3; letter-spacing: 0.2em;">OFFICIAL MEMBER</span>
            <h2 id="display-name" class="member-name">---</h2>
            
            <div id="hourglass-root" class="hourglass-wrapper"></div>
            
            <div id="display-days" style="font-size: 1.8rem; font-weight: 800;">---</div>
        </div>
        <button id="btn-attendance" class="btn-main">Loading...</button>
        <div class="l3-card">
            <div style="font-size:0.6rem; opacity:0.3; font-weight:800;">MY BUDDY</div>
            <div id="buddy-name" style="font-family:'Shippori Mincho',serif; font-size:1.3rem; font-weight:800; margin:5px 0 10px;">---</div>
            <div id="stamp-root" class="stamp-grid"></div>
        </div>
        <div class="l3-card">
            <h3 style="font-size: 0.7rem; letter-spacing: 0.1em; margin: 0;">FEEDBACK</h3>
            <textarea id="feedback-text" class="feedback-area" placeholder="„Çµ„Éº„ÇØ„É´„Å∏„ÅÆ„ÅîÊÑèË¶ã„Çí„Å©„ÅÜ„Åû"></textarea>
            <button onclick="sendFeedback()" style="width:100%; padding:10px; border-radius:10px; background:var(--l3-navy); color:#fff; border:none; font-weight:800;">SEND</button>
        </div>
    </main>

    <main id="tab-list" class="container"><div id="list-root" class="list-grid"></div></main>
    <main id="tab-info" class="container"><div id="info-root"></div></main>

    <nav class="nav">
        <div class="nav-item nav-active" id="nav-mypage" onclick="switchTab('mypage')">My Page</div>
        <div class="nav-item" id="nav-list" onclick="switchTab('list')">List</div>
        <div class="nav-item" id="nav-info" onclick="switchTab('info')">Info</div>
    </nav>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby21EhDYkN_Gjzad4ks8hsyquV61hhuI2VKylGAQwyYvpmvP1iZowqIaM6RdR64HVJeOA/exec";
        const LIFF_ID = "2008760618-igOldYtb";
        let memberCache = null;

        // --- URL„Çí„É™„É≥„ÇØ„Å´Â§âÊèõ„Åô„ÇãÈñ¢Êï∞ ---
        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(/\n/g, '<br>').replace(urlRegex, function(url) {
                return '<a href="' + url + '" target="_blank">' + url + '</a>';
            });
        }

        // --- Á†ÇÊôÇË®à„ÇíÊèèÁîª„Åô„ÇãÈñ¢Êï∞ (ÊÆã„ÇäÊó•Êï∞„ÅßÁ†Ç„ÅÆÈáè„ÅåÂ§â„Çè„Çã) ---
        function drawHourglass(remainingDays) {
            const totalDays = 1095; // 3Âπ¥
            const ratio = Math.min(1, Math.max(0, remainingDays / totalDays));
            const topHeight = 20 * ratio; // Á†Ç„ÅÆÈ´ò„Åï(ÊúÄÂ§ß20)
            const bottomHeight = 20 * (1 - ratio);
            
            const svg = `
            <svg class="hg-svg" viewBox="0 0 40 50">
                <path d="M5 5 L35 5 L22 25 L35 45 L5 45 L18 25 Z" fill="none" stroke="#002b5b" stroke-width="2"/>
                <rect x="19.5" y="24" width="1" height="22" class="sand-stream" />
                <path d="M20 25 L${20-15*ratio} ${25-topHeight} L${20+15*ratio} ${25-topHeight} Z" fill="#e1ff00" />
                <rect x="${20-15*(1-ratio)}" y="${45-bottomHeight}" width="${30*(1-ratio)}" height="${bottomHeight}" fill="#e1ff00" />
            </svg>`;
            document.getElementById('hourglass-root').innerHTML = svg;
        }

        async function initPortal() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const res = await fetch(`${GAS_URL}?id=${profile.userId}`);
                const data = await res.json();
                memberCache = data.allMembers;

                updateAttendanceButton(data.hasAttendedToday, profile.userId);
                document.getElementById('display-name').innerText = data.userName;
                
                const days = Math.max(0, Math.ceil((new Date(data.graduationDate) - new Date()) / 86400000));
                document.getElementById('display-days').innerText = days + " DAYS";
                
                // Á†ÇÊôÇË®àÊèèÁîª
                drawHourglass(days);

                document.getElementById('buddy-name').innerText = data.buddyName;
                document.getElementById('stamp-root').innerHTML = Array(8).fill(0).map((_, i) => `<div class="slot ${i < data.stamps ? 'filled' : ''}">${i < data.stamps ? '‚úî' : i + 1}</div>`).join('');

                renderList(memberCache);
                
                // --- 2&3. URLÊúâÂäπÂåñ„Å®„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÊèèÁîª ---
                document.getElementById('info-root').innerHTML = data.infoData.map(i => `
                    <div class="accordion-item">
                        <button class="accordion-trigger" onclick="toggleAccordion(this)">
                            ${i.title}<span>‚ñº</span>
                        </button>
                        <div class="accordion-content">
                            <div class="accordion-inner">${linkify(i.content)}</div>
                        </div>
                    </div>`).join('');
            } catch (e) { console.error(e); }
        }

        // („Åù„ÅÆ‰ªñ„ÅÆÈñ¢Êï∞„ÅØÊó¢Â≠òÈÄö„Çä)
        function renderList(members) {
            document.getElementById('list-root').innerHTML = members.map(m => `
                <div class="m-card" onclick="toggleMember(this)">
                    <div class="m-icon">${m.photo ? `<img src="${m.photo}" class="m-img" loading="lazy">` : `<img src="l3-logo-official_transparent.png" style="width:25px;opacity:0.2;" loading="lazy">`}</div>
                    <span style="font-weight:800; font-size:0.9rem;">${m.name}</span><br><small style="opacity:0.3;">${m.term}Êúü</small>
                    <div class="detail-pane">
                        <div class="d-row"><span class="d-label">Nickname</span><span class="d-val">${m.nickname || "---"}</span></div>
                        <div class="d-row"><span class="d-row-inner"><span class="d-label">Birth</span> <span class="d-val">${m.birthYear}</span></span><span class="d-row-inner"><span class="d-label">Exp</span> <span class="d-val">${m.experience}</span></span></div>
                        <div class="d-row"><span class="d-label">Hobby</span><span class="d-val">${m.hobby}</span></div>
                        <div class="d-row"><span class="d-label">Manga</span><span class="d-val">${m.manga}</span></div>
                        <div class="d-row"><span class="d-label">Racket</span><span class="d-val">${m.racket}</span></div>
                    </div>
                </div>`).join('');
        }

        function updateAttendanceButton(attended, userId) {
            const btn = document.getElementById('btn-attendance');
            btn.innerText = attended ? "‚ùå Âá∫Â∏≠„ÇíÂèñ„ÇäÊ∂à„Åô" : "üìñ Âá∫Â∏≠„ÇíË®òÈå≤„Åô„Çã";
            btn.className = "btn-main " + (attended ? "btn-cancel" : "btn-attend");
            btn.onclick = () => handleAttendance(attended ? "cancel_attendance" : "attendance", attended ? "Âèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºü" : "Âá∫Â∏≠„Åó„Åæ„Åô„ÅãÔºü", userId);
        }

        async function handleAttendance(action, msg, userId) {
            if (!confirm(msg)) return;
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action, userId }) });
            location.reload();
        }

        async function sendFeedback() {
            const text = document.getElementById('feedback-text').value; if (!text) return;
            const profile = await liff.getProfile();
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "feedback", userId: profile.userId, message: text }) });
            alert("ÈÄÅ‰ø°ÂÆå‰∫ÜÔºÅ"); document.getElementById('feedback-text').value = "";
        }

        function switchTab(t) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.getElementById('nav-'+t).classList.add('nav-active');
        }
        function toggleMember(el) { const ex = el.classList.contains('expanded'); document.querySelectorAll('.m-card').forEach(c=>c.classList.remove('expanded')); if(!ex) el.classList.add('expanded'); }
        function toggleAccordion(el) { const c = el.nextElementSibling; c.style.maxHeight = c.style.maxHeight ? null : c.scrollHeight + "px"; }
        initPortal();
    </script>
</body>
</html>
