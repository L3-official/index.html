/**
 * GAS: L3 Portal Backend (最終完成版)
 * A(0):LINE ID, B(1):名前, L(11):バディID, M(12):アイコンURL, N(13):真のID
 */

const SS = SpreadsheetApp.getActiveSpreadsheet();
const MEMBER_SHEET = SS.getSheetByName("会員名簿");
const ATTEND_SHEET = SS.getSheetByName("出席簿");
const STAMP_SHEET = SS.getSheetByName("バディスタンプ");
const INFO_SHEET = SS.getSheetByName("info");

function doGet(e) {
  const userId = e.parameter.id;
  const allMembers = getAllMemberData();
  const myData = allMembers.find(m => m.trueId === userId);
  const infoData = getInfoData();

  let buddyName = "---";
  if (myData && myData.buddyTargetId && myData.buddyTargetId !== "---") {
    const buddyData = allMembers.find(m => m.lineId === myData.buddyTargetId);
    if (buddyData) buddyName = buddyData.B_name;
  }

  const response = {
    myId: myData ? myData.trueId : null,
    userName: myData ? myData.B_name : "ゲスト",
    joinDate: myData ? myData.joinDate : null,
    graduationDate: myData ? myData.graduationDate : null,
    buddyName: buddyName,
    isAdmin: myData ? myData.isAdmin : false,
    allMembers: myData ? allMembers : [], 
    infoData: infoData,
    hasAttendedToday: checkAttendance(userId),
    stampIcons: myData ? getStampIcons(myData.lineId) : []
  };

  return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const params = JSON.parse(e.postData.contents);
  const action = params.action;
  let result = { success: false };

  if (action === "edit_profile") result = saveProfile(params);
  if (action === "generate_matches") result = generateMatching(params.mode);
  if (action === "attendance") result = recordAttendance(params.userId);
  if (action === "cancel_attendance") result = cancelAttendance(params.userId);
  if (action === "record_buddy") result = recordBuddyInteraction(params.userId);
  if (action === "feedback") result = saveFeedback(params.userId, params.message);

  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- スタンプ管理 (アイコン履歴) ---
function recordBuddyInteraction(trueId) {
  const all = getAllMemberData();
  const me = all.find(m => m.trueId === trueId);
  if (!me || !me.buddyTargetId || me.buddyTargetId === "---") return { success: false, msg: "バディが決まっていません" };

  const today = Utilities.formatDate(new Date(), "JST", "yyyy/MM/dd");
  const data = STAMP_SHEET.getDataRange().getValues();
  
  // その日1回だけの重複チェック
  const alreadyDone = data.some(row => Utilities.formatDate(new Date(row[0]), "JST", "yyyy/MM/dd") === today && String(row[1]) === me.lineId);
  if (alreadyDone) return { success: false, msg: "今日の記録は完了しています" };

  const buddy = all.find(m => m.lineId === me.buddyTargetId);
  STAMP_SHEET.appendRow([new Date(), me.lineId, me.buddyTargetId, buddy ? buddy.photo : ""]);
  return { success: true };
}

function getStampIcons(lineId) {
  const data = STAMP_SHEET.getDataRange().getValues();
  return data.filter(row => String(row[1]) === lineId).map(row => row[3]).slice(0, 8);
}

// --- 割り振り・L列更新ロジック ---
function generateMatching(mode) {
  const attendees = getAllMemberData().filter(m => checkAttendance(m.trueId));
  if (attendees.length < 4) return { error: "出席者が足りません" };

  let pool = [];
  let assigned = new Set();
  
  // バディペアをシャッフルして作成
  let shuffled = attendees.sort(() => Math.random() - 0.5);
  let pairs = [];
  for (let i = 0; i < shuffled.length; i++) {
    if (assigned.has(shuffled[i].lineId)) continue;
    let partner = shuffled.find((m, idx) => idx > i && !assigned.has(m.lineId));
    if (partner) {
      pairs.push([shuffled[i], partner]);
      assigned.add(shuffled[i].lineId); assigned.add(partner.lineId);
    } else {
      pool.push(shuffled[i]); // 余った人
    }
  }

  // 会員名簿のL列を全員更新
  const memberData = MEMBER_SHEET.getDataRange().getValues();
  pairs.forEach(p => {
    updateBuddyIdInSheet(p[0].lineId, p[1].lineId);
    updateBuddyIdInSheet(p[1].lineId, p[0].lineId);
  });
  pool.forEach(s => updateBuddyIdInSheet(s.lineId, "---"));

  // コート表示用データ作成
  let assignments = [];
  let courtPool = [];
  pairs.forEach(p => courtPool.push(p[0], p[1]));
  courtPool = courtPool.concat(pool);

  for (let i = 0; i < 3; i++) {
    if (courtPool.length >= 4) assignments.push({ court: i+1, players: courtPool.splice(0, 4), type: "MIX" });
  }
  return { assignments };
}

function updateBuddyIdInSheet(lineId, buddyLineId) {
  const data = MEMBER_SHEET.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === lineId) {
      MEMBER_SHEET.getRange(i + 1, 12).setValue(buddyLineId); // L列(12列目)を上書き
      break;
    }
  }
}

// --- 以下、既存機能の維持 ---
function getAllMemberData() {
  const rows = MEMBER_SHEET.getDataRange().getValues();
  rows.shift();
  return rows.map(row => ({
    lineId: String(row[0]), B_name: row[1], term: row[2], joinDate: row[3], graduationDate: row[4],
    nickname: row[5], birthYear: row[6], experience: row[7], hobby: row[8], manga: row[9],
    racket: row[10], buddyTargetId: String(row[11]), photo: row[12], trueId: String(row[13]),
    level: row[14] || "うさぎ", isAdmin: row[15] === true || row[15] === "TRUE"
  }));
}

function checkAttendance(userId) {
  if (!userId) return false;
  const data = ATTEND_SHEET.getDataRange().getValues();
  const today = Utilities.formatDate(new Date(), "JST", "yyyy/MM/dd");
  return data.some(row => String(row[0]) === userId && Utilities.formatDate(new Date(row[1]), "JST", "yyyy/MM/dd") === today);
}

function recordAttendance(userId) {
  if (!userId || checkAttendance(userId)) return { success: true };
  ATTEND_SHEET.appendRow([userId, new Date()]);
  return { success: true };
}

function cancelAttendance(userId) {
  const data = ATTEND_SHEET.getDataRange().getValues();
  const today = Utilities.formatDate(new Date(), "JST", "yyyy/MM/dd");
  for (let i = data.length - 1; i >= 0; i--) {
    if (String(data[i][0]) === userId && Utilities.formatDate(new Date(data[i][1]), "JST", "yyyy/MM/dd") === today) {
      ATTEND_SHEET.deleteRow(i + 1); return { success: true };
    }
  }
  return { success: false };
}

function getInfoData() {
  try {
    const rows = INFO_SHEET.getDataRange().getValues(); rows.shift();
    return rows.map(r => ({ title: r[0], content: r[1] }));
  } catch(e) { return []; }
}

function saveProfile(p) {
  const data = MEMBER_SHEET.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][13]) === p.userId) {
      MEMBER_SHEET.getRange(i + 1, 15).setValue(p.level); MEMBER_SHEET.getRange(i + 1, 6).setValue(p.nickname);
      MEMBER_SHEET.getRange(i + 1, 7).setValue(p.birthYear); MEMBER_SHEET.getRange(i + 1, 8).setValue(p.experience);
      MEMBER_SHEET.getRange(i + 1, 9).setValue(p.hobby); MEMBER_SHEET.getRange(i + 1, 10).setValue(p.manga);
      MEMBER_SHEET.getRange(i + 1, 11).setValue(p.racket); return { success: true };
    }
  }
  return { success: false };
}

function saveFeedback(userId, message) {
  SS.getSheetByName("ご意見箱").appendRow([new Date(), userId, message]);
  return { success: true };
}
